<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Directory</title>
  <link rel="stylesheet" href="style.css">
  <!-- Security headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; connect-src 'self' https://*.microsoftonline.com https://login.microsoft.com https://maanit-func.azurewebsites.net; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self'">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <!-- Cache control -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div class="container">
    <h1>üë• User Directory</h1>
    
    <div class="filter-container">
      <div class="search-filters">
        <div class="filter-group">
          <label for="searchInput">Search:</label>
          <input type="text" id="searchInput" placeholder="Filter by email..." class="search-input">
        </div>
        <div class="filter-group">
          <label for="roleFilter">Role:</label>
          <select id="roleFilter" class="role-select">
            <option value="">All Roles</option>
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
        </div>
      </div>
    </div>
    
    <div id="users" class="table-container">
      <div class="spinner"></div>
    </div>
    
    <div id="pagination" class="pagination hidden">
      <button id="prevPage" class="button pagination-button">&laquo; Previous</button>
      <span id="pageInfo" class="page-info">Page 1 of 1</span>
      <button id="nextPage" class="button pagination-button">Next &raquo;</button>
    </div>
    
    <div class="button-container">
      <a class="button" href="index.html">‚Üê Home</a>
      <button id="refreshButton" class="button">Refresh Data</button>
    </div>
  </div>

  <script>
    // State management for user data and pagination
    const state = {
      users: [],
      filteredUsers: [],
      currentPage: 1,
      itemsPerPage: 10,
      loaded: false
    };
    
    // Sanitize string to prevent XSS
    function sanitizeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Format date in a friendly way
    function formatDate(dateString) {
      if (!dateString) return 'Never';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return 'Today';
      } else if (diffDays === 1) {
        return 'Yesterday';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    
    // Format password age in a friendly way
    function getPasswordAge(dateString) {
      if (!dateString) return 'Unknown';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 30) {
        return `${diffDays} days`;
      } else {
        const months = Math.floor(diffDays / 30);
        return `${months} month${months !== 1 ? 's' : ''}`;
      }
    }
    
    // Initialize the data and render the table
    function loadUsers() {
      const target = document.getElementById("users");
      
      // Show loading spinner
      target.innerHTML = '<div class="spinner"></div>';
      
      // Fetch user data from secure API
      fetch('/api/users', {
        credentials: 'include',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(userData => {
          state.users = userData;
          state.filteredUsers = [...userData];
          state.loaded = true;
          
          // Render and setup
          renderUsers();
          setupFilters();
        })
        .catch(error => {
          target.innerHTML = `<div class="error-message">Error loading users: ${sanitizeHtml(error.message)}</div>`;
        });
    }
    
    // Render users with pagination
    function renderUsers() {
      if (!state.loaded) return;
      
      const target = document.getElementById("users");
      const paginationElement = document.getElementById("pagination");
      const pageInfo = document.getElementById("pageInfo");
      const prevButton = document.getElementById("prevPage");
      const nextButton = document.getElementById("nextPage");
      
      // Calculate pagination
      const totalPages = Math.ceil(state.filteredUsers.length / state.itemsPerPage);
      const startIndex = (state.currentPage - 1) * state.itemsPerPage;
      const endIndex = Math.min(startIndex + state.itemsPerPage, state.filteredUsers.length);
      const currentPageUsers = state.filteredUsers.slice(startIndex, endIndex);
      
      // Update pagination display
      pageInfo.textContent = `Page ${state.currentPage} of ${totalPages || 1}`;
      prevButton.disabled = state.currentPage <= 1;
      nextButton.disabled = state.currentPage >= totalPages;
      
      // Show/hide pagination based on data
      if (state.filteredUsers.length > state.itemsPerPage) {
        paginationElement.classList.remove("hidden");
      } else {
        paginationElement.classList.add("hidden");
      }
      
      // Create table element
      const table = document.createElement("table");
      table.className = "fancy-table";
      
      // Table header - SECURITY ENHANCED VERSION
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Status</th>
          <th>2FA</th>
          <th>Last Login</th>
          <th>Password Age</th>
          <th>Role</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Table body
      const tbody = document.createElement("tbody");
      
      if (currentPageUsers.length === 0) {
        // No results after filtering
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="7" class="no-results">No users match your search criteria</td>
        `;
        tbody.appendChild(tr);
      } else {
        // Render user rows with sanitized data
        currentPageUsers.forEach(user => {
          const tr = document.createElement("tr");
          
          // Sanitize all data to prevent XSS
          const id = sanitizeHtml(user.id);
          const email = sanitizeHtml(user.email);
          const status = sanitizeHtml(user.status || 'Unknown');
          const twoFA = user.twoFactorEnabled ? 
            '<span class="badge success">Enabled</span>' : 
            '<span class="badge warning">Disabled</span>';
          const lastLogin = formatDate(user.lastLogin);
          const passwordAge = getPasswordAge(user.passwordLastChanged);
          const role = sanitizeHtml(user.role || '‚Äì');
          
          tr.innerHTML = `
            <td data-label="ID">${id}</td>
            <td data-label="Email">${email}</td>
            <td data-label="Status">
              <span class="badge ${status === 'Active' ? 'success' : 'danger'}">${status}</span>
            </td>
            <td data-label="2FA">${twoFA}</td>
            <td data-label="Last Login">${lastLogin}</td>
            <td data-label="Password Age">${passwordAge}</td>
            <td data-label="Role">${role}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      table.appendChild(tbody);
      
      // Update DOM
      target.innerHTML = "";
      target.appendChild(table);
    }
    
    // Set up filtering and search functionality
    function setupFilters() {
      const searchInput = document.getElementById("searchInput");
      const roleFilter = document.getElementById("roleFilter");
      
      // Add event listeners
      searchInput.addEventListener("input", applyFilters);
      roleFilter.addEventListener("change", applyFilters);
      
      // Set up pagination handlers
      document.getElementById("prevPage").addEventListener("click", () => {
        if (state.currentPage > 1) {
          state.currentPage--;
          renderUsers();
          // Scroll to top of user list
          document.getElementById("users").scrollIntoView({ behavior: "smooth" });
        }
      });
      
      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(state.filteredUsers.length / state.itemsPerPage);
        if (state.currentPage < totalPages) {
          state.currentPage++;
          renderUsers();
          // Scroll to top of user list
          document.getElementById("users").scrollIntoView({ behavior: "smooth" });
        }
      });
      
      // Setup refresh button
      document.getElementById("refreshButton").addEventListener("click", () => {
        loadUsers();
      });
    }
    
    // Apply filters based on search input and role selection
    function applyFilters() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const roleFilter = document.getElementById("roleFilter").value.toLowerCase();
      
      // Filter the users based on search term and role
      state.filteredUsers = state.users.filter(user => {
        const email = (user.email || '').toLowerCase();
        const role = (user.role || '').toLowerCase();
        
        const matchesSearch = !searchTerm || email.includes(searchTerm);
        const matchesRole = !roleFilter || role === roleFilter;
        
        return matchesSearch && matchesRole;
      });
      
      // Reset to first page and re-render
      state.currentPage = 1;
      renderUsers();
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</body>
</html>