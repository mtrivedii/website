<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Directory</title>
  <link rel="stylesheet" href="style.css">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div id="content-container">
    <!-- Content will be loaded dynamically -->
  </div>

  <script>
    // Check authentication and render appropriate content
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('auth_token');
      const userRole = localStorage.getItem('user_role');
      const container = document.getElementById('content-container');
      
      console.log("Token:", token ? "exists" : "none");
      console.log("User role:", userRole || "none");
      
      // If authenticated as admin, show users page
      if (token && userRole && userRole.toLowerCase() === 'admin') {
        container.innerHTML = `
          <div class="container">
            <h1>üë• User Directory</h1>
            
            <div class="filter-container">
              <div class="search-filters">
                <div class="filter-group">
                  <label for="searchInput">Search:</label>
                  <input type="text" id="searchInput" placeholder="Filter by email..." class="search-input">
                </div>
                <div class="filter-group">
                  <label for="roleFilter">Role:</label>
                  <select id="roleFilter" class="role-select">
                    <option value="">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div id="users" class="table-container">
              <div class="spinner"></div>
            </div>
            
            <div id="pagination" class="pagination hidden">
              <button id="prevPage" class="button pagination-button">&laquo; Previous</button>
              <span id="pageInfo" class="page-info">Page 1 of 1</span>
              <button id="nextPage" class="button pagination-button">Next &raquo;</button>
            </div>
            
            <div class="button-container">
              <a class="button" href="index.html">‚Üê Home</a>
              <button id="refreshButton" class="button">Refresh Data</button>
              <button id="logout-button" class="button warning">Logout</button>
            </div>
          </div>
        `;
        
        // Add logout functionality
        document.getElementById('logout-button').addEventListener('click', function() {
          localStorage.removeItem('auth_token');
          localStorage.removeItem('user_role');
          localStorage.removeItem('user_email');
          document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/';
        });
        
        // Initialize users data
        loadUsers();
      } 
      // If not authenticated or not admin, show unauthorized page
      else {
        container.innerHTML = `
          <div class="container">
            <h1>üîí Unauthorized Access</h1>
            
            <div class="card">
              <h2>Authentication Required</h2>
              <p>You must be logged in with appropriate permissions to access this page.</p>
              <div class="button-container">
                <a href="/login.html" class="button">Login</a>
                <a href="/" class="button secondary">Return to Home</a>
              </div>
            </div>
          </div>
        `;
      }
    });
  
    // State management for user data and pagination
    const state = {
      users: [],
      filteredUsers: [],
      currentPage: 1,
      itemsPerPage: 10,
      loaded: false
    };
    
    // Sanitize string to prevent XSS
    function sanitizeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Format date in a friendly way
    function formatDate(dateString) {
      if (!dateString) return 'Never';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return 'Today';
      } else if (diffDays === 1) {
        return 'Yesterday';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    
    // Format password age in a friendly way
    function getPasswordAge(dateString) {
      if (!dateString) return 'Unknown';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 30) {
        return `${diffDays} days`;
      } else {
        const months = Math.floor(diffDays / 30);
        return `${months} month${months !== 1 ? 's' : ''}`;
      }
    }
    
    // Initialize the data and render the table
    function loadUsers() {
      const target = document.getElementById("users");
      if (!target) return; // Exit if element not found (page not loaded yet)
      
      // Show loading spinner
      target.innerHTML = '<div class="spinner"></div>';
      
      // Get JWT token for authentication
      const token = localStorage.getItem('auth_token');
      const headers = {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache'
      };
      
      // Add Authorization header if token exists
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      // Try to fetch from API first
      fetch('/api/users', {
        method: 'GET',
        headers: headers,
        credentials: 'include'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(userData => {
        // Store the user data in state
        state.users = userData;
        state.filteredUsers = [...userData];
        state.loaded = true;
        
        // Render and setup
        renderUsers();
        setupFilters();
      })
      .catch(error => {
        console.error('Error loading users:', error);
        
        // Fallback to static data if API call fails
        const fallbackData = [
          { 
            id: 1, 
            email: "maanit49@gmail.com", 
            status: "Active",
            twoFactorEnabled: false,
            lastLogin: null,
            passwordLastChanged: "2023-11-15T10:30:00Z",
            role: ""
          },
          { 
            id: 7, 
            email: "StudentAdmin@fictproftaak35.onmicrosoft.com", 
            status: "Active",
            twoFactorEnabled: true,
            lastLogin: new Date(Date.now() - 3*24*60*60*1000).toISOString(),
            passwordLastChanged: "2024-03-12T14:20:00Z",
            role: "admin"
          },
          { 
            id: 9, 
            email: "security.officer@example.com", 
            status: "Active",
            twoFactorEnabled: true,
            lastLogin: new Date(Date.now() - 1*24*60*60*1000).toISOString(),
            passwordLastChanged: "2024-01-20T09:15:00Z",
            role: "admin"
          },
          { 
            id: 10, 
            email: "marketing.director@example.com", 
            status: "Active",
            twoFactorEnabled: false,
            lastLogin: new Date(Date.now() - 5*24*60*60*1000).toISOString(),
            passwordLastChanged: "2024-02-10T16:45:00Z",
            role: "user"
          }
        ];
        
        // Display a warning about using fallback data
        target.innerHTML = '<div class="warning">API error: Using fallback data (not from database)</div>';
        
        // Use fallback data
        state.users = fallbackData;
        state.filteredUsers = [...fallbackData];
        state.loaded = true;
        
        // Render and setup with fallback data
        renderUsers();
        setupFilters();
      });
    }
    
    // Render users with pagination
    function renderUsers() {
      if (!state.loaded) return;
      
      const target = document.getElementById("users");
      if (!target) return; // Exit if element not found
      
      const paginationElement = document.getElementById("pagination");
      const pageInfo = document.getElementById("pageInfo");
      const prevButton = document.getElementById("prevPage");
      const nextButton = document.getElementById("nextPage");
      
      // Calculate pagination
      const totalPages = Math.ceil(state.filteredUsers.length / state.itemsPerPage);
      const startIndex = (state.currentPage - 1) * state.itemsPerPage;
      const endIndex = Math.min(startIndex + state.itemsPerPage, state.filteredUsers.length);
      const currentPageUsers = state.filteredUsers.slice(startIndex, endIndex);
      
      // Update pagination display
      pageInfo.textContent = `Page ${state.currentPage} of ${totalPages || 1}`;
      prevButton.disabled = state.currentPage <= 1;
      nextButton.disabled = state.currentPage >= totalPages;
      
      // Show/hide pagination based on data
      if (state.filteredUsers.length > state.itemsPerPage) {
        paginationElement.classList.remove("hidden");
      } else {
        paginationElement.classList.add("hidden");
      }
      
      // Create table element
      const table = document.createElement("table");
      table.className = "fancy-table";
      
      // Table header
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Status</th>
          <th>2FA</th>
          <th>Last Login</th>
          <th>Password Age</th>
          <th>Role</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Table body
      const tbody = document.createElement("tbody");
      
      if (currentPageUsers.length === 0) {
        // No results after filtering
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="7" class="no-results">No users match your search criteria</td>
        `;
        tbody.appendChild(tr);
      } else {
        // Render user rows with sanitized data
        currentPageUsers.forEach(user => {
          const tr = document.createElement("tr");
          
          // Sanitize all data to prevent XSS
          const id = sanitizeHtml(user.id);
          const email = sanitizeHtml(user.email);
          const status = sanitizeHtml(user.status || 'Unknown');
          const twoFA = user.twoFactorEnabled ? 
            '<span class="badge success">Enabled</span>' : 
            '<span class="badge warning">Disabled</span>';
          const lastLogin = formatDate(user.lastLogin);
          const passwordAge = getPasswordAge(user.passwordLastChanged);
          const role = sanitizeHtml(user.role || user.Role || '‚Äì');
          
          tr.innerHTML = `
            <td data-label="ID">${id}</td>
            <td data-label="Email">${email}</td>
            <td data-label="Status">
              <span class="badge ${status === 'Active' ? 'success' : 'danger'}">${status}</span>
            </td>
            <td data-label="2FA">${twoFA}</td>
            <td data-label="Last Login">${lastLogin}</td>
            <td data-label="Password Age">${passwordAge}</td>
            <td data-label="Role">${role}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      table.appendChild(tbody);
      
      // Preserve any warning message if present
      const warning = target.querySelector('.warning');
      target.innerHTML = '';
      if (warning) {
        target.appendChild(warning);
      }
      
      // Add table to the DOM
      target.appendChild(table);
    }
    
    // Set up filtering and search functionality
    function setupFilters() {
      const searchInput = document.getElementById("searchInput");
      const roleFilter = document.getElementById("roleFilter");
      
      if (!searchInput || !roleFilter) return; // Exit if elements not found
      
      // Add event listeners
      searchInput.addEventListener("input", applyFilters);
      roleFilter.addEventListener("change", applyFilters);
      
      // Set up pagination handlers
      document.getElementById("prevPage").addEventListener("click", () => {
        if (state.currentPage > 1) {
          state.currentPage--;
          renderUsers();
          // Scroll to top of user list
          document.getElementById("users").scrollIntoView({ behavior: "smooth" });
        }
      });
      
      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(state.filteredUsers.length / state.itemsPerPage);
        if (state.currentPage < totalPages) {
          state.currentPage++;
          renderUsers();
          // Scroll to top of user list
          document.getElementById("users").scrollIntoView({ behavior: "smooth" });
        }
      });
      
      // Setup refresh button
      document.getElementById("refreshButton").addEventListener("click", () => {
        loadUsers();
      });
    }
    
    // Apply filters based on search input and role selection
    function applyFilters() {
      const searchInput = document.getElementById("searchInput");
      const roleFilter = document.getElementById("roleFilter");
      
      if (!searchInput || !roleFilter) return; // Exit if elements not found
      
      const searchTerm = searchInput.value.toLowerCase();
      const roleFilterValue = roleFilter.value.toLowerCase();
      
      // Filter the users based on search term and role
      state.filteredUsers = state.users.filter(user => {
        const email = (user.email || '').toLowerCase();
        const role = (user.role || user.Role || '').toLowerCase();
        
        const matchesSearch = !searchTerm || email.includes(searchTerm);
        const matchesRole = !roleFilterValue || role === roleFilterValue;
        
        return matchesSearch && matchesRole;
      });
      
      // Reset to first page and re-render
      state.currentPage = 1;
      renderUsers();
    }
  </script>
  
  <style>
    .card {
      background-color: #1a1a1a;
      border-radius: 10px;
      padding: 20px;
      margin: 2rem auto;
      max-width: 500px;
      box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
    }
    
    .button.warning {
      background-color: #ff3366;
      color: white;
    }
    
    .button.warning:hover {
      background-color: #ff4d7d;
      box-shadow: 0 0 10px rgba(255, 51, 102, 0.7);
    }
    
    .button.secondary {
      background-color: #444;
      color: white;
    }
    
    .button.secondary:hover {
      background-color: #555;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
  </style>
</body>
</html>