<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Directory</title>
  <link rel="stylesheet" href="style.css">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
</head>
<body>
  <div class="container">
    <h1>üë• User Directory</h1>

    <div class="filter-container">
      <div class="search-filters">
        <div class="filter-group">
          <label for="searchInput">Search:</label>
          <input type="text" id="searchInput" placeholder="Filter by email..." class="search-input">
        </div>
        <div class="filter-group">
          <label for="roleFilter">Role:</label>
          <select id="roleFilter" class="role-select">
            <option value="">All Roles</option>
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
        </div>
      </div>
    </div>

    <div id="users" class="table-container">
      <div class="spinner"></div>
    </div>

    <div id="pagination" class="pagination hidden">
      <button id="prevPage" class="button pagination-button">&laquo; Previous</button>
      <span id="pageInfo" class="page-info">Page 1 of 1</span>
      <button id="nextPage" class="button pagination-button">Next &raquo;</button>
    </div>

    <div class="button-container">
      <a class="button" href="index.html">‚Üê Home</a>
      <button id="refreshButton" class="button">Refresh Data</button>
    </div>
  </div>

  <script>
    const state = {
      users: [],
      filteredUsers: [],
      currentPage: 1,
      itemsPerPage: 10,
      loaded: false
    };

    async function fetchUserData() {
      try {
        const response = await fetch('/api/users', { cache: "no-store" });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Failed to fetch user data:', error);
        return [];
      }
    }

    function sanitizeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function formatDate(dateString) {
      if (!dateString) return 'Never';
      const date = new Date(dateString);
      const now = new Date();
      const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Yesterday';
      if (diff < 7) return `${diff} days ago`;
      return date.toLocaleDateString();
    }

    function getPasswordAge(dateString) {
      if (!dateString) return 'Unknown';
      const date = new Date(dateString);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      return diffDays < 30 ? `${diffDays} days` : `${Math.floor(diffDays / 30)} month(s)`;
    }

    async function loadUsers() {
      const target = document.getElementById("users");
      target.innerHTML = '<div class="spinner"></div>';

      try {
        const data = await fetchUserData();
        state.users = data.map(user => ({
          id: user.id,
          email: user.email,
          status: "Active",
          twoFactorEnabled: false,
          lastLogin: null,
          passwordLastChanged: null,
          Role: user.Role || ''
        }));
        state.filteredUsers = [...state.users];
        state.loaded = true;

        renderUsers();
        setupFilters();
      } catch (err) {
        console.error('Error loading users:', err);
        target.innerHTML = '<p class="warning">Failed to load users.</p>';
      }
    }

    function renderUsers() {
      const target = document.getElementById("users");
      const paginationElement = document.getElementById("pagination");
      const pageInfo = document.getElementById("pageInfo");

      const totalPages = Math.ceil(state.filteredUsers.length / state.itemsPerPage);
      const startIndex = (state.currentPage - 1) * state.itemsPerPage;
      const currentPageUsers = state.filteredUsers.slice(startIndex, startIndex + state.itemsPerPage);

      pageInfo.textContent = `Page ${state.currentPage} of ${totalPages || 1}`;
      document.getElementById("prevPage").disabled = state.currentPage <= 1;
      document.getElementById("nextPage").disabled = state.currentPage >= totalPages;
      paginationElement.classList.toggle("hidden", totalPages <= 1);

      const table = document.createElement("table");
      table.className = "fancy-table";

      table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th><th>Email</th><th>Status</th><th>2FA</th>
            <th>Last Login</th><th>Password Age</th><th>Role</th>
          </tr>
        </thead>
        <tbody>
          ${currentPageUsers.map(user => `
            <tr>
              <td data-label="ID">${sanitizeHtml(user.id)}</td>
              <td data-label="Email">${sanitizeHtml(user.email)}</td>
              <td data-label="Status"><span class="badge success">Active</span></td>
              <td data-label="2FA">${user.twoFactorEnabled ? '<span class="badge success">Enabled</span>' : '<span class="badge warning">Disabled</span>'}</td>
              <td data-label="Last Login">${formatDate(user.lastLogin)}</td>
              <td data-label="Password Age">${getPasswordAge(user.passwordLastChanged)}</td>
              <td data-label="Role">${sanitizeHtml(user.Role || '‚Äî')}</td>
            </tr>
          `).join('')}
        </tbody>
      `;

      target.innerHTML = "";
      target.appendChild(table);
    }

    function setupFilters() {
      document.getElementById("searchInput").addEventListener("input", applyFilters);
      document.getElementById("roleFilter").addEventListener("change", applyFilters);
      document.getElementById("prevPage").addEventListener("click", () => {
        if (state.currentPage > 1) {
          state.currentPage--;
          renderUsers();
        }
      });
      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(state.filteredUsers.length / state.itemsPerPage);
        if (state.currentPage < totalPages) {
          state.currentPage++;
          renderUsers();
        }
      });
      document.getElementById("refreshButton").addEventListener("click", loadUsers);
    }

    function applyFilters() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const role = document.getElementById("roleFilter").value.toLowerCase();
      state.filteredUsers = state.users.filter(user => {
        return (!searchTerm || user.email.toLowerCase().includes(searchTerm)) &&
               (!role || (user.Role || '').toLowerCase() === role);
      });
      state.currentPage = 1;
      renderUsers();
    }

    document.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</body>
</html>
