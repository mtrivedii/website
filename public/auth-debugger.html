<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Debugger</title>
  <style>
    body {
      background-color: #111;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1, h2 {
      color: #00e6b8;
    }
    .card {
      background-color: #222;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .debug-section {
      font-family: monospace;
      background-color: #333;
      border-radius: 5px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    .debug-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .timestamp {
      color: #888;
      margin-right: 10px;
    }
    .button {
      background-color: #00e6b8;
      color: #111;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .button:hover {
      background-color: #00ffc8;
    }
    .token-display {
      word-break: break-all;
      margin-top: 10px;
      padding: 10px;
      background-color: #333;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Authentication Debugger</h1>
    
    <div class="card">
      <h2>Auth Token Status</h2>
      <div id="token-info">Loading...</div>
      <div id="token-content" class="token-display" style="display:none;"></div>
      <div style="margin-top: 15px;">
        <button class="button" id="btn-home">Go Home</button>
        <button class="button" id="btn-login">Go to Login</button>
        <button class="button" id="btn-logout">Logout</button>
      </div>
    </div>
    
    <div class="card">
      <h2>Manual Auth Test</h2>
      <div>
        <button class="button" id="btn-check-admin">Check Admin Status</button>
        <button class="button" id="btn-delete-token">Delete Auth Token</button>
        <button class="button" id="btn-set-admin">Set Role to Admin</button>
      </div>
    </div>
    
    <div class="card">
      <h2>Debug Log</h2>
      <div id="debug-log" class="debug-section"></div>
    </div>
  </div>

  <script>
    // Debug logging
    function debugLog(message) {
      console.log(message);
      const logContainer = document.getElementById('debug-log');
      const entry = document.createElement('div');
      entry.className = 'debug-entry';
      const timestamp = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="timestamp">${timestamp}</span> ${message}`;
      logContainer.prepend(entry);
    }
    
    // Update token info
    function updateTokenInfo() {
      const tokenInfo = document.getElementById('token-info');
      const tokenContent = document.getElementById('token-content');
      const token = localStorage.getItem('auth_token');
      
      if (token) {
        tokenInfo.innerHTML = 'Token found in localStorage';
        
        // Decode token to show contents
        try {
          const parts = token.split('.');
          if (parts.length === 3) {
            const payload = JSON.parse(atob(parts[1]));
            tokenContent.innerHTML = `
              <strong>Token payload:</strong><br>
              User ID: ${payload.userId || 'Not found'}<br>
              Email: ${payload.email || 'Not found'}<br>
              Role: ${payload.role || 'Not found'}<br>
              Expires: ${new Date(payload.exp * 1000).toLocaleString()}<br><br>
              <strong>Raw token:</strong><br>
              ${token}
            `;
            tokenContent.style.display = 'block';
            
            // Store role for convenience
            if (payload.role) {
              localStorage.setItem('user_role', payload.role);
              localStorage.setItem('user_email', payload.email || '');
              debugLog(`Stored role in localStorage: ${payload.role}`);
            }
          } else {
            tokenInfo.innerHTML = 'Token found but invalid format';
            tokenContent.style.display = 'none';
          }
        } catch (e) {
          tokenInfo.innerHTML = `Token found but couldn't be decoded: ${e.message}`;
          tokenContent.style.display = 'none';
        }
      } else {
        tokenInfo.innerHTML = 'No auth token found in localStorage';
        tokenContent.style.display = 'none';
      }
    }
    
    // Check admin status
    async function checkAdminStatus() {
      debugLog('Checking admin status...');
      const token = localStorage.getItem('auth_token');
      
      if (!token) {
        debugLog('No token found. Please login first.');
        return;
      }
      
      try {
        const response = await fetch('/api/checkAdmin', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
          },
          credentials: 'include'
        });
        
        debugLog(`Admin check status: ${response.status}`);
        
        const text = await response.text();
        try {
          const data = JSON.parse(text);
          debugLog(`Response data: ${JSON.stringify(data)}`);
        } catch (e) {
          debugLog(`Response (not JSON): ${text.substring(0, 100)}`);
        }
        
        if (response.ok) {
          debugLog('✅ Admin access confirmed');
        } else {
          debugLog('❌ Admin check failed');
        }
      } catch (error) {
        debugLog(`Error checking admin status: ${error.message}`);
      }
    }
    
    // Event handlers
    document.getElementById('btn-home').addEventListener('click', () => window.location.href = '/');
    document.getElementById('btn-login').addEventListener('click', () => window.location.href = '/login.html');
    
    document.getElementById('btn-logout').addEventListener('click', () => {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('user_email');
      document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
      debugLog('Logged out - cleared auth data');
      updateTokenInfo();
    });
    
    document.getElementById('btn-check-admin').addEventListener('click', checkAdminStatus);
    
    document.getElementById('btn-delete-token').addEventListener('click', () => {
      localStorage.removeItem('auth_token');
      debugLog('Deleted auth_token from localStorage');
      updateTokenInfo();
    });
    
    document.getElementById('btn-set-admin').addEventListener('click', () => {
      localStorage.setItem('user_role', 'admin');
      debugLog('Set user_role to "admin" in localStorage');
    });
    
    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
      debugLog('Page loaded');
      updateTokenInfo();
    });
  </script>
</body>
</html>